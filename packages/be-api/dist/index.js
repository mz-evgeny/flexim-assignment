'use strict';var k=require('express'),m=require('mongoose'),_=require('cors');function _interopDefault(e){return e&&e.__esModule?e:{default:e}}var k__default=/*#__PURE__*/_interopDefault(k);var m__default=/*#__PURE__*/_interopDefault(m);var ___default=/*#__PURE__*/_interopDefault(_);var l=async()=>{await m__default.default.connect(process.env.MONGO_URI||"mongodb://127.0.0.1:27017/flexim");},d=async()=>{await m__default.default.disconnect();};var f=new m.Schema({name:{type:String,required:true},country:{type:String,required:true}});var o=m.model("Supplier",f);var S=new m.Schema({sku:{type:String,required:true,unique:true},name:{type:String,required:true},description:{type:String,required:true},supplierId:{type:m.Schema.Types.ObjectId,ref:o,required:true},manufacturingDate:{type:Date,required:true}});var y=m.model("Product",S);async function P({page:r=1,limit:e=50,sortField:t="sku",sortOrder:n="asc",searchTerm:s=""}){let w=(r-1)*e,c={};s&&(c.$or=[{sku:{$regex:s,$options:"i"}},{name:{$regex:s,$options:"i"}}]);let p={};t==="supplier"?p["supplier.name"]=n==="asc"?1:-1:p[t]=n==="asc"?1:-1;let[u]=await y.aggregate([{$match:c},{$lookup:{from:"suppliers",localField:"supplierId",foreignField:"_id",as:"supplier"}},{$unwind:"$supplier"},{$facet:{data:[{$sort:p},{$skip:w},{$limit:e},{$project:{_id:1,sku:1,name:1,description:1,supplierId:"$supplier._id",manufacturingDate:1}}],total:[{$group:{_id:null,count:{$sum:1}}}]}}]),a=u.total[0]?.count||0;return {data:u.data,total:a,page:r,totalPages:Math.ceil(a/e)}}var $=async()=>await o.find().lean();var i=k__default.default(),x=8e3;i.use(___default.default());i.get("/products",async(r,e)=>{let t=await P(r.query);e.send(t);});i.get("/suppliers",async(r,e)=>{let t=await $();e.send(t);});i.listen(x,async()=>{await l(),console.info(`\u{1F680} Server ready at port : ${x}`);});var I=async()=>{await d(),console.info("\u{1F6D1} Database connection closed."),process.exit(0);};process.on("SIGINT",I);process.on("SIGTERM",I);
//# sourceMappingURL=index.js.map
//# sourceMappingURL=index.js.map